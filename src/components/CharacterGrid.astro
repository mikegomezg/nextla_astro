---
import { getEntry } from "astro:content";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

// Import character images in correct order
import silas from "../assets/characters/1-silas.png";
import kate from "../assets/characters/2-cors.png"; // Cors
import victoria from "../assets/characters/3-victoria.png";
import mercedes from "../assets/characters/4-mercedes.png";
import john from "../assets/characters/5-john.png";
import enrique from "../assets/characters/6-enrique.png";

interface Character {
    name: string;
    role: string;
    bio: string;
    image?: string;
}

const charactersContent = await getEntry("landing", "characters");

if (!charactersContent) {
    throw new Error(
        "Characters content not found: characters entry missing from landing collection",
    );
}

const { characters = [] } = charactersContent.data;

// Manually reorder characters to match image order
const orderedCharacters: Character[] = [
    characters.find((c) => c.name.startsWith("Silas"))!,
    characters.find((c) => c.name.startsWith("Cors"))!, // Cors is Kate
    characters.find((c) => c.name.startsWith("Victoria"))!,
    characters.find((c) => c.name.startsWith("Mercedes"))!,
    characters.find((c) => c.name.startsWith("John"))!,
    characters.find((c) => c.name.startsWith("Enrique"))!,
];

// Ordered character images
const orderedCharacterImages: ImageMetadata[] = [
    silas,
    kate,
    victoria,
    mercedes,
    john,
    enrique,
];

// Gradient fallback colors
const bgColors = [
    "from-primary/30 to-secondary/30",
    "from-secondary/30 to-highlight/30",
    "from-highlight/30 to-accent/30",
    "from-accent/30 to-primary/30",
    "from-primary/30 to-highlight/30",
    "from-secondary/30 to-accent/30",
];
---

<section
    id="characters"
    aria-labelledby="characters-heading"
    class="py-8 px-4 bg-background container-xl"
>
    <div>
        <h2
            id="characters-heading"
            class="mb-8 heading-responsive text-center text-secondary text-shadow-light dark:text-secondary select-none"
        >
            Characters
        </h2>

        <!-- Desktop grid view -->
        <div class="hidden lg:grid grid-cols-3 gap-6">
            {
                orderedCharacterImages.map((image, index) => (
                    <div class="card-base min-w-[280px] max-w-[350px] w-full flex flex-col items-center text-center p-6">
                        <div class="w-40 h-40 mb-4 overflow-hidden rounded-full">
                            {image ? (
                                <Image
                                    src={image}
                                    alt={`${orderedCharacters[index]?.name} - ${orderedCharacters[index]?.role}`}
                                    class="object-cover w-full h-full rounded-full drop-shadow-md"
                                    loading="eager"
                                    decoding="async"
                                />
                            ) : (
                                <div
                                    class={`w-full h-full rounded-full bg-gradient-to-br ${bgColors[index % bgColors.length]} flex items-center justify-center drop-shadow-md`}
                                >
                                    <span class="text-3xl font-bold text-text">
                                        {orderedCharacters[index]?.name.charAt(0)}
                                    </span>
                                </div>
                            )}
                        </div>
                        <h3 class="text-xl font-semibold text-highlight mb-1">
                            {orderedCharacters[index]?.name}
                        </h3>
                        <p class="text-accent text-sm mb-3">
                            {orderedCharacters[index]?.role}
                        </p>
                        <p class="text-text text-responsive">
                            {orderedCharacters[index]?.bio}
                        </p>
                    </div>
                ))
            }
        </div>

        <!-- Mobile scroll view -->
        <div
            id="character-scroll"
            class="lg:hidden overflow-x-scroll scrollbar-hide pb-4 -mx-4 px-4"
        >
            <div class="flex space-x-4" style="min-width: min-content;">
                {
                    orderedCharacterImages.map((image, index) => (
                        <div class="card-base min-w-[280px] max-w-[320px] flex flex-col items-center text-center p-6">
                            <div class="w-28 h-28 mb-3 overflow-hidden rounded-full">
                                {image ? (
                                    <Image
                                        src={image}
                                        alt={`${orderedCharacters[index]?.name} - ${orderedCharacters[index]?.role}`}
                                        class="object-cover w-full h-full rounded-full drop-shadow-md"
                                        loading="eager"
                                        decoding="async"
                                    />
                                ) : (
                                    <div
                                        class={`w-full h-full rounded-full bg-gradient-to-br ${bgColors[index % bgColors.length]} flex items-center justify-center drop-shadow-md`}
                                    >
                                        <span class="text-2xl font-bold text-text">
                                            {orderedCharacters[index]?.name.charAt(0)}
                                        </span>
                                    </div>
                                )}
                            </div>
                            <h3 class="text-lg font-semibold text-highlight mb-1">
                                {orderedCharacters[index]?.name}
                            </h3>
                            <p class="text-accent text-xs mb-2">
                                {orderedCharacters[index]?.role}
                            </p>
                            <p class="text-text text-xs line-clamp-3">
                                {orderedCharacters[index]?.bio}
                            </p>
                        </div>
                    ))
                }
            </div>
        </div>

        <!-- Mobile navigation indicators -->
        <div class="flex justify-center space-x-2 mt-4 lg:hidden select-none">
            {
                orderedCharacterImages.map((_, index) => (
                    <button
                        type="button"
                        class={`w-2 h-2 rounded-full transition-all duration-300 ${
                            index === 0 ? "bg-primary scale-125" : "bg-muted/20"
                        }`}
                        aria-label={`Go to character ${index + 1}`}
                    />
                ))
            }
        </div>
    </div>
</section>

<script>
    let activeIndex = 0;
    const scrollContainer = document.getElementById("character-scroll") as HTMLElement;

    if (scrollContainer) {
        const characterCards = scrollContainer.querySelectorAll(".card-base");
        const pagerButtons = document.querySelectorAll(
            "#characters .flex.justify-center button",
        );

        // Function to scroll to a specific character
        function scrollToCharacter(index: number): void {
            const card = characterCards[index] as HTMLElement;
            if (card) {
                scrollContainer.scrollTo({
                    left: card.offsetLeft - 16, // adjust for padding
                    behavior: "smooth" as ScrollBehavior,
                });
                activeIndex = index;
                updateActiveDot();
            }
        }

        // Update the active dot indicator
        function updateActiveDot(): void {
            pagerButtons.forEach((button, idx) => {
                if (idx === activeIndex) {
                    button.classList.add("bg-primary", "scale-125");
                    button.classList.remove("bg-muted/20");
                } else {
                    button.classList.remove("bg-primary", "scale-125");
                    button.classList.add("bg-muted/20");
                }
            });
        }

        // Add click event listeners to pager buttons
        pagerButtons.forEach((button, index) => {
            button.addEventListener("click", () => {
                scrollToCharacter(index);
            });
        });

        // Track scroll position to update active dot
        scrollContainer.addEventListener("scroll", () => {
            const scrollLeft = scrollContainer.scrollLeft;
            const firstCard = characterCards[0] as HTMLElement;
            const cardWidth = firstCard.offsetWidth + 16; // card width + gap
            const newIndex = Math.round(scrollLeft / cardWidth);

            if (
                newIndex !== activeIndex &&
                newIndex >= 0 &&
                newIndex < characterCards.length
            ) {
                activeIndex = newIndex;
                updateActiveDot();
            }
        });
    }
</script>
